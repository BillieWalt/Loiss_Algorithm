#include<stdio.h>
#include<stdlib.h>

//x左环移y位
#define Rotl(_x, _y) (((_x) << (_y)) | ((_x) >> (32 - (_y))))

const unsigned char S[256]=
{0x0, 0x2, 0x4, 0x6, 0x8, 0xa, 0xc, 0xe,
0x10, 0x12, 0x14, 0x16, 0x18, 0x1a, 0x1c, 0x1e,
0x20, 0x22, 0x24, 0x26, 0x28, 0x2a, 0x2c, 0x2e,
0x30, 0x32, 0x34, 0x36, 0x38, 0x3a, 0x3c, 0x3e,
0x40, 0x42, 0x44, 0x46, 0x48, 0x4a, 0x4c, 0x4e,
0x50, 0x52, 0x54, 0x56, 0x58, 0x5a, 0x5c, 0x5e,
0x60, 0x62, 0x64, 0x66, 0x68, 0x6a, 0x6c, 0x6e,
0x70, 0x72, 0x74, 0x76, 0x78, 0x7a, 0x7c, 0x7e,
0x80, 0x82, 0x84, 0x86, 0x88, 0x8a, 0x8c, 0x8e,
0x90, 0x92, 0x94, 0x96, 0x98, 0x9a, 0x9c, 0x9e,
0xa0, 0xa2, 0xa4, 0xa6, 0xa8, 0xaa, 0xac, 0xae,
0xb0, 0xb2, 0xb4, 0xb6, 0xb8, 0xba, 0xbc, 0xbe,
0xc0, 0xc2, 0xc4, 0xc6, 0xc8, 0xca, 0xcc, 0xce,
0xd0, 0xd2, 0xd4, 0xd6, 0xd8, 0xda, 0xdc, 0xde,
0xe0, 0xe2, 0xe4, 0xe6, 0xe8, 0xea, 0xec, 0xee,
0xf0, 0xf2, 0xf4, 0xf6, 0xf8, 0xfa, 0xfc, 0xfe,
0xa9, 0xab, 0xad, 0xaf, 0xa1, 0xa3, 0xa5, 0xa7,
0xb9, 0xbb, 0xbd, 0xbf, 0xb1, 0xb3, 0xb5, 0xb7,
0x89, 0x8b, 0x8d, 0x8f, 0x81, 0x83, 0x85, 0x87,
0x99, 0x9b, 0x9d, 0x9f, 0x91, 0x93, 0x95, 0x97,
0xe9, 0xeb, 0xed, 0xef, 0xe1, 0xe3, 0xe5, 0xe7,
0xf9, 0xfb, 0xfd, 0xff, 0xf1, 0xf3, 0xf5, 0xf7,
0xc9, 0xcb, 0xcd, 0xcf, 0xc1, 0xc3, 0xc5, 0xc7,
0xd9, 0xdb, 0xdd, 0xdf, 0xd1, 0xd3, 0xd5, 0xd7,
0x29, 0x2b, 0x2d, 0x2f, 0x21, 0x23, 0x25, 0x27,
0x39, 0x3b, 0x3d, 0x3f, 0x31, 0x33, 0x35, 0x37,
0x09, 0x0b, 0x0d, 0x0f, 0x01, 0x03, 0x05, 0x07,
0x19, 0x1b, 0x1d, 0x1f, 0x11, 0x13, 0x15, 0x17,
0x69, 0x6b, 0x6d, 0x6f, 0x61, 0x63, 0x65, 0x67,
0x79, 0x7b, 0x7d, 0x7f, 0x71, 0x73, 0x75, 0x77,
0x49, 0x4b, 0x4d, 0x4f, 0x41, 0x43, 0x45, 0x47,
0x59, 0x5b, 0x5d, 0x5f, 0x51, 0x53, 0x55, 0x57,
};//S盒
const unsigned char S_inverse[256]=
{0x00, 0xd4, 0x01, 0xd5, 0x02, 0xd6, 0x03, 0xd7,
0x04, 0xd0, 0x05, 0xd1, 0x06, 0xd2, 0x07, 0xd3,
0x08, 0xdc, 0x09, 0xdd, 0x0a, 0xde, 0x0b, 0xdf,
0x0c, 0xd8, 0x0d, 0xd9, 0x0e, 0xda, 0x0f, 0xdb,
0x10, 0xc4, 0x11, 0xc5, 0x12, 0xc6, 0x13, 0xc7,
0x14, 0xc0, 0x15, 0xc1, 0x16, 0xc2, 0x17, 0xc3,
0x18, 0xcc, 0x19, 0xcd, 0x1a, 0xce, 0x1b, 0xcf,
0x1c, 0xc8, 0x1d, 0xc9, 0x1e, 0xca, 0x1f, 0xcb,
0x20, 0xf4, 0x21, 0xf5, 0x22, 0xf6, 0x23, 0xf7,
0x24, 0xf0, 0x25, 0xf1, 0x26, 0xf2, 0x27, 0xf3,
0x28, 0xfc, 0x29, 0xfd, 0x2a, 0xfe, 0x2b, 0xff,
0x2c, 0xf8, 0x2d, 0xf9, 0x2e, 0xfa, 0x2f, 0xfb,
0x30, 0xe4, 0x31, 0xe5, 0x32, 0xe6, 0x33, 0xe7,
0x34, 0xe0, 0x35, 0xe1, 0x36, 0xe2, 0x37, 0xe3,
0x38, 0xec, 0x39, 0xed, 0x3a, 0xee, 0x3b, 0xef,
0x3c, 0xe8, 0x3d, 0xe9, 0x3e, 0xea, 0x3f, 0xeb,
0x40, 0x94, 0x41, 0x95, 0x42, 0x96, 0x43, 0x97,
0x44, 0x90, 0x45, 0x91, 0x46, 0x92, 0x47, 0x93,
0x48, 0x9c, 0x49, 0x9d, 0x4a, 0x9e, 0x4b, 0x9f,
0x4c, 0x98, 0x4d, 0x99, 0x4e, 0x9a, 0x4f, 0x9b,
0x50, 0x84, 0x51, 0x85, 0x52, 0x86, 0x53, 0x87,
0x54, 0x80, 0x55, 0x81, 0x56, 0x82, 0x57, 0x83,
0x58, 0x8c, 0x59, 0x8d, 0x5a, 0x8e, 0x5b, 0x8f,
0x5c, 0x88, 0x5d, 0x89, 0x5e, 0x8a, 0x5f, 0x8b,
0x60, 0xb4, 0x61, 0xb5, 0x62, 0xb6, 0x63, 0xb7,
0x64, 0xb0, 0x65, 0xb1, 0x66, 0xb2, 0x67, 0xb3,
0x68, 0xbc, 0x69, 0xbd, 0x6a, 0xbe, 0x6b, 0xbf,
0x6c, 0xb8, 0x6d, 0xb9, 0x6e, 0xba, 0x6f, 0xbb,
0x70, 0xa4, 0x71, 0xa5, 0x72, 0xa6, 0x73, 0xa7,
0x74, 0xa0, 0x75, 0xa1, 0x76, 0xa2, 0x77, 0xa3,
0x78, 0xac, 0x79, 0xad, 0x7a, 0xae, 0x7b, 0xaf,
0x7c, 0xa8, 0x7d, 0xa9, 0x7e, 0xaa, 0x7f, 0xab,
};//S逆盒

const unsigned char S1[256]=
{0x55, 0xC2, 0x63, 0x71, 0x3B, 0xC8, 0x47, 0x86,
0x9F, 0x3C, 0xDA, 0x5B, 0x29, 0xAA, 0xFD, 0x77,
0x8C, 0xC5, 0x94, 0x0C, 0xA6, 0x1A, 0x13, 0x00,
0xE3, 0xA8, 0x16, 0x72, 0x40, 0xF9, 0xF8, 0x42,
0x44, 0x26, 0x68, 0x96, 0x81, 0xD9, 0x45, 0x3E,
0x10, 0x76, 0xC6, 0xA7, 0x8B, 0x39, 0x43, 0xE1,
0x3A, 0xB5, 0x56, 0x2A, 0xC0, 0x6D, 0xB3, 0x05,
0x22, 0x66, 0xBF, 0xDC, 0x0B, 0xFA, 0x62, 0x48,
0xDD, 0x20, 0x11, 0x06, 0x36, 0xC9, 0xC1, 0xCF,
0xF6, 0x27, 0x52, 0xBB, 0x69, 0xF5, 0xD4, 0x87,
0x7F, 0x84, 0x4C, 0xD2, 0x9C, 0x57, 0xA4, 0xBC,
0x4F, 0x9A, 0xDF, 0xFE, 0xD6, 0x8D, 0x7A, 0xEB,
0x2B, 0x53, 0xD8, 0x5C, 0xA1, 0x14, 0x17, 0xFB,
0x23, 0xD5, 0x7D, 0x30, 0x67, 0x73, 0x08, 0x09,
0xEE, 0xB7, 0x70, 0x3F, 0x61, 0xB2, 0x19, 0x8E,
0x4E, 0xE5, 0x4B, 0x93, 0x8F, 0x5D, 0xDB, 0xA9,
0xAD, 0xF1, 0xAE, 0x2E, 0xCB, 0x0D, 0xFC, 0xF4,
0x2D, 0x46, 0x6E, 0x1D, 0x97, 0xE8, 0xD1, 0xE9,
0x4D, 0x37, 0xA5, 0x75, 0x5E, 0x83, 0x9E, 0xAB,
0x82, 0x9D, 0xB9, 0x1C, 0xE0, 0xCD, 0x49, 0x89,
0x01, 0xB6, 0xBD, 0x58, 0x24, 0xA2, 0x5F, 0x38,
0x78, 0x99, 0x15, 0x90, 0x50, 0xB8, 0x95, 0xE4,
0xD0, 0x91, 0xC7, 0xCE, 0xED, 0x0F, 0xB4, 0x6F,
0xA0, 0xCC, 0xF0, 0x02, 0x4A, 0x79, 0xC3, 0xDE,
0xA3, 0xEF, 0xEA, 0x51, 0xE6, 0x6B, 0x18, 0xEC,
0x1B, 0x2C, 0x80, 0xF7, 0x74, 0xE7, 0xFF, 0x21,
0x5A, 0x6A, 0x54, 0x1E, 0x41, 0x31, 0x92, 0x35,
0xC4, 0x33, 0x07, 0x0A, 0xBA, 0x7E, 0x0E, 0x34,
0x88, 0xB1, 0x98, 0x7C, 0xF3, 0x3D, 0x60, 0x6C,
0x7B, 0xCA, 0xD3, 0x1F, 0x32, 0x65, 0x04, 0x28,
0x64, 0xBE, 0x85, 0x9B, 0x2F, 0x59, 0x8A, 0xD7,
0xB0, 0x25, 0xAC, 0xAF, 0x12, 0x03, 0xE2, 0xF2,
};//S盒S1

const unsigned char S2[256]=
{0x61, 0x97, 0xFF, 0xE9, 0x66, 0x56, 0xF1, 0xF3,
0x54, 0x72, 0xCC, 0x4D, 0x85, 0x52, 0x7A, 0x70,
0xD0, 0x2E, 0x4C, 0x58, 0xBE, 0x88, 0x7F, 0x5A,
0x2F, 0x1B, 0x47, 0xAF, 0x9B, 0xD5, 0xBF, 0x81,
0xC3, 0x4E, 0x86, 0x2D, 0x6A, 0x9C, 0xCE, 0x20,
0x2B, 0x53, 0x6D, 0xFD, 0x3C, 0xBC, 0x33, 0x22,
0xF7, 0x59, 0xC9, 0x63, 0x6E, 0x8D, 0xDD, 0xF2,
0xE3, 0x1A, 0x75, 0xDA, 0x13, 0x1D, 0x68, 0x42,
0xA4, 0x3F, 0xB7, 0x46, 0x90, 0x12, 0x73, 0xEB,
0xFA, 0xF6, 0x09, 0x40, 0xA5, 0xE0, 0xB4, 0xB1,
0x51, 0x8E, 0x06, 0x34, 0x7D, 0xDF, 0x99, 0x6F,
0xAA, 0x0B, 0x80, 0x95, 0x25, 0xEA, 0x87, 0xCD,
0xDC, 0x0C, 0x43, 0xFB, 0xA7, 0xBD, 0x9E, 0xFC,
0xEE, 0x9F, 0x74, 0xB6, 0xCF, 0xEF, 0x16, 0x0F,
0x78, 0xD1, 0x92, 0x64, 0xD6, 0x84, 0x48, 0x41,
0x08, 0x60, 0x5D, 0x2A, 0xB8, 0x4F, 0xE2, 0x69,
0x01, 0xC1, 0x31, 0x5F, 0x62, 0x49, 0xB2, 0x93,
0x00, 0xCB, 0x04, 0x18, 0x07, 0x71, 0x17, 0xE4,
0xAC, 0x8B, 0xB0, 0x7E, 0xF8, 0x44, 0x5B, 0xAD,
0x98, 0xA0, 0x27, 0x4B, 0x3A, 0xB5, 0xF0, 0x83,
0xF9, 0x14, 0xE7, 0x23, 0x77, 0xD2, 0x10, 0xAE,
0xB3, 0x36, 0x30, 0x3B, 0x1C, 0x03, 0x82, 0x38,
0x0E, 0x7B, 0x50, 0xA6, 0x1F, 0x7C, 0xCA, 0xC2,
0x02, 0x2C, 0xA9, 0x8A, 0x39, 0x15, 0xF4, 0xD9,
0xA3, 0x55, 0x32, 0x96, 0xC8, 0x8C, 0xC0, 0x05,
0x67, 0x1E, 0xEC, 0x19, 0x29, 0x89, 0xF5, 0x21,
0x37, 0xBB, 0xE1, 0x57, 0xA2, 0xC7, 0xE6, 0x8F,
0xAB, 0x91, 0x35, 0x28, 0xD3, 0xD7, 0x79, 0xBA,
0xA1, 0x6C, 0xB9, 0xDE, 0xA8, 0x5E, 0xFE, 0x6B,
0xC5, 0xED, 0x65, 0x9A, 0x45, 0xC6, 0xC4, 0x9D,
0x94, 0x24, 0x0D, 0x0A, 0xE5, 0x76, 0x3D, 0xE8,
0x26, 0x5C, 0xD4, 0x4A, 0xD8, 0x11, 0xDB, 0x3E,
};//S盒S2

/*密钥扩展*/
void Key_E(char Init_k[17],unsigned char Init_v[17],unsigned char X[32],unsigned char Y[16])
{
	int i,j,k;
	for(i=0;i<16;i++)
	{
		X[i]=Init_k[i];
	}
	for(j=0;j<16;j++)
	{
		X[16+j]=Init_k[j]^Init_v[j];
	}
	for(k=0;k<16;k++)
	{
		Y[k]=Init_v[k];
	}
}

unsigned int LFSR(unsigned char B[32],unsigned char v)
{
	int i,j,k;
	unsigned char Index[8]={0,2,5,11,15,17,24,29};
	unsigned char Choice[4]={7,20,26,31};
	unsigned char M[8], m=0x0;
	unsigned int X=0x0;
	for(k=0;k<4;k++)
		{
			X^=(unsigned int)B[Choice[k]]<<k*8;
		}
	M[0]=S_inverse[B[Index[0]]];
	M[1]=B[Index[1]];
	M[2]=S[B[Index[2]]];
	M[3]=B[Index[3]];
	M[4]=B[Index[4]];
	M[5]=S_inverse[B[Index[5]]];
	M[6]=S[B[Index[6]]];
	M[7]=B[Index[7]];
	for(i=0;i<32;i++)
	{
		B[i]=B[i+1];
	}
	for(j=0;j<8;j++)
	{
		m=M[j]^m;
	}
	B[31]=m^v;
	return X;
}

unsigned char F_function(unsigned int X, unsigned int R[1])
{
	int i, j, k;   //X=S31S26S20S7
	unsigned int Y=0x0, m=0;
	unsigned char T[4], w;
	X=X^R[0];
	for(i=0;i<4;i++)
	{
		T[i]=(unsigned char)(X>>(i*8));  //低到高，右到左Ti=S7,20,26,31
	}
	for(j=0;j<4;j++)
	{
		T[j]=S1[T[j]];
	}
	for(k=0;k<4;k++)
	{
		Y^=((unsigned int)T[k])<<k*8;  //X^=(unsigned int)B[Choice[k]]<<k*8;
	}
	Y=Y^Rotl(Y,2)^Rotl(Y,10)^Rotl(Y,18)^Rotl(Y,24);
	R[0]=Y;
	w=(unsigned char)(Rotl(Y,8));
	return w;
}

unsigned char Bomm(unsigned char w, unsigned char Y[16])
{
//	int i;
	unsigned char h,l,v;
	h=w>>4;
	l=w%16;
	v=Y[h]^w;
	Y[l]^=S2[w];
	if(h==l)
		Y[h]=Y[l]^S2[Y[l]];
	else
		Y[h]=Y[h]^S2[w];
	return v;
}



void ED(char *M,char *CM)
{
	unsigned char Y[16]={'\0'};													//两个记忆和一个控制
	//内置信息声明并初始化结束
	unsigned char LFSR_X[32]={'\0'};
	char Init_k[17]={'\0'};//初始密钥
	unsigned char Init_v[17]={0x51,0x7c,0xc1,0xb7,0x27,0x22,0x0a,0x94,0xfe,0x12,0xab,0xe8,0xfa,0x9a,0x6e,0xe0};//初始向量
	/////*******************/////////
    unsigned int X,R[1]={0};
    unsigned char w,v=0x0;
	char mingw=0,miw=0;		//mingw为明文，miw为密文
	int i=0,j=0,k=0,fileLen=0;
	FILE *fp1=NULL;
	FILE *fp2=NULL;
    //变量定义
	if((fp1 = fopen(M,"rb")) == NULL){
		printf("打开文件错误。");
		getchar();
		exit(0);
		}
	if((fp2 = fopen(CM,"wb")) == NULL){
		printf("打开文件错误。");
		getchar();
		exit(0);
	}
	//打开文件
	printf("请输入密钥(不超过16字节)：");
	gets(Init_k);
	fflush(stdin);
		/////*******************/////////
	Key_E(Init_k,Init_v,&LFSR_X[0],&Y[0]);//    密钥扩展，生成LFSR

	fseek(fp1,0,SEEK_END);
	fileLen = ftell(fp1);
	rewind(fp1);

    //进动加密
	for(i=0;i<fileLen;i++)
	{
		fread(&mingw,sizeof(char),1,fp1);//读字符
		X=LFSR(&LFSR_X[0],v);
		w=F_function(X,&R[0]);
		v=Bomm(w,&Y[0]);
		miw = mingw^v;
		fwrite(&miw,sizeof(char),1,fp2);
	}
	fclose(fp1);
	fclose(fp2);
	printf("\n\tok\n");
}

void main()
{
	int i=0;
	char CM[40]={'\0'};//密文文件名
	char M[40]={'\0'};//明文文件名
	int choose=1;
	printf("Loiss序列密码\n");
	while(choose!=0)
	{
		printf("\n请选择：\n");
		printf("加密，请输入1：\n");
		printf("解密，请输入2：\n");
		printf("退出，请输入0：\n");
		scanf("%d",&choose);
		fflush(stdin);//清空输入缓冲区，这里是为了确保不影响后面的数据读取
		switch(choose){
		case 1:
			{
				printf("\n加密：\n");
				printf("请输入明文文件名：");
				gets(M);
				fflush(stdin);
				printf("请输入密文文件名：");
				gets(CM);
				fflush(stdin);
				ED(M,CM);
				printf("加密完成！\n");
			}
			break;
		case 2:
			{
				printf("\n解密：\n");
				printf("请输入密文文件名：");
				gets(M);
				fflush(stdin);
				printf("请输入解密后文件名：");
				gets(CM);
				fflush(stdin);
				ED(M,CM);
				printf("解密完成！\n");
			}
		case 0:
			break;
		default:
			printf("\n输入错误！\n");
			break;
		}
		system("pause");
		system("cls");
	}
}
